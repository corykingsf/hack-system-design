
#### 伪分布式架构：为什么叫伪分布式？ 一个业务集群，但是每一个业务仍然是单点，子系统的性能仍然受到单机资源的限制，无法扩展


Keepalived is a piece of software which can be used to achieve high availability by assigning two or more nodes a virtual IP and monitoring those nodes, failing over when one goes down. Keepalived can do more, like load balancing and monitoring, but this tutorial focusses on a very simple setup, just IP failover.

## 怎么解决？  反向代理 ！！！


![alt txt](https://raw.githubusercontent.com/corykingsf/hack-system-design-pixel/main/imgSnipaste_2021-06-25_23-19-23.png)


### 反向代理：web server是集群，具体内部访问的是哪个ip, 用户是不知道的

### 一般用什么做反向代理？
- 软件层面：nginx/apache
- 操作系统层面： LVS
- 硬件：F5

### 反向代理解决什么问题？
- （1）子web系统的性能，不再受到单台机器资源限制，可以扩展  (反向代理带来了新的问题：  负载均衡问题)
- (2)子web系统，实现了高可用(伪集群 -> 真集群)  （反向代理的高可用问题,反向代理层成了单点）

### 反向代理如何实施负载均衡？
- 负载均衡方法：随机，轮询(第1个请求给到第1台，第2个请求给到第2台)，静态权重轮询（两台服务器机器配置不同从而处理能力不同，可以配置一个经验值，比如第一台的处理能力是第二台的两倍，将第一台的负载权重配置为2，第二台的负载权重配置为1），动态权重轮询(根据实际处理能力分配权重， 遗留问题，下节会讨论)，一致性哈希(相同的ip,相同的用户的请求落在同一个服务器上，需要一个业务属性作为负载均衡的抓手)
- 负载均衡抓手： 四层（转发/交换），七层(转发/交换)
   四层：根据用户的ip和端口来做哈希
   七层：根据http协议的某些属性来做哈希， session id, 用户id
   二层，三层转发：二层根据数据链路层的mac地址，三层根据网络层的ip地址，这些可能在router这些硬件中来进行转发交换
   


   ![alt txt](https://raw.githubusercontent.com/corykingsf/hack-system-design-pixel/main/imgSnipaste_2021-06-26_09-13-03.png)


client通过dns server得到nginx的外网Ip， nginx使用两个节点，这两个节点使用相同的虚ip, 这两个节点的外网ip都是dns返回解析的外网ip

当nginx挂了的时候，keepalived能够探测出有一台nginx不可服务了，于是他会将请求的流量导入到备用nginx上，两台nginx配置完全一样，同一时间，两台nginx实际上只有一台在对外提供服务，另外一台是standby状态，整个资源的利用率只有50%

![alt txt](https://raw.githubusercontent.com/corykingsf/hack-system-design-pixel/main/imgSnipaste_2021-06-26_09-16-43.png)

what is keepalived?  keepalived监控


   ![alt txt](https://raw.githubusercontent.com/corykingsf/hack-system-design-pixel/main/imgSnipaste_2021-06-26_09-21-14.png)




